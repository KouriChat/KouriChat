<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KouriChat - 角色设定</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/static/mom.ico">
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/dark-mode.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #4f46e5;
            --background-color: #f0f4f8;  
            --text-color: #1e293b;
            --card-bg: rgba(255, 255, 255, 0.494);
            --card-border: rgba(255, 255, 255, 0.5);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        [data-bs-theme="dark"] {
            --background-color: #1a1f2e;  /* 深色背景 */
            --text-color: #f8fafc;        /* 浅色文字 */
            --card-bg: rgba(30, 41, 59, 0.612); /* 深色卡片背景 */
            --card-border: rgba(255, 255, 255, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        .container {
            margin: auto;
        }

        .glass-panel {
            background: var(--card-bg);
            border-radius: 1rem;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .form-label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-control {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--card-border);
            transition: all 0.3s ease;
            min-height: 100px;
            resize: vertical;
            overflow-y: auto;
            max-height: 500px;
        }

        .form-control:focus {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
        }

        .form-control::placeholder {
            color: var(--text-color);
            opacity: 0.65;
        }

        /* 暗色模式下的按钮样式 */
        [data-bs-theme="dark"] .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        [data-bs-theme="dark"] .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* 保存按钮样式 */
        .btn-save {
            width: 100%; /* 占据100%宽度 */
            padding: 0.75rem; /* 按钮内边距 */
            margin-top: 1rem; /* 按钮上边距 */
            background-color: var(--primary-color); /* 背景颜色 */
            color: white; /* 字体颜色 */
            border: none; /* 无边框 */
            border-radius: 0.5rem; /* 圆角 */
            transition: background-color 0.3s ease; /* 背景颜色过渡 */
        }

        .btn-save:hover {
            background-color: var(--secondary-color); /* 悬停时的背景颜色 */
        }
        
        /* 人设选择器样式 */
        .avatar-selector {
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid var(--card-border);
            flex-wrap: wrap; /* 允许在小屏幕上换行 */
        }
        
        .avatar-selector select {
            flex-grow: 1;
            min-width: 200px; /* 确保下拉框有足够宽度 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--card-border);
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
            height: 42px;
        }
        
        .avatar-selector button {
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        
        .avatar-selector select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(99, 102, 241, 0.25);
            outline: none;
        }
        
        .avatar-selector label {
            font-weight: 500;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            white-space: nowrap;
            font-size: 1rem;
        }
        
        .avatar-selector label i {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }
        
        /* 添加加载动画 */
        .loading {
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            border-radius: 1rem;
        }
        
        .loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            z-index: 1001;
        }
        
        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        /* 添加深色模式下的模态框样式 */
        [data-bs-theme="dark"] .modal-content {
            background-color: #1a1f2e;
            color: #f8fafc;
        }
        
        [data-bs-theme="dark"] .modal-header,
        [data-bs-theme="dark"] .modal-footer {
            border-color: #2d3748;
        }
        
        [data-bs-theme="dark"] pre {
            background-color: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
        }
        
        /* 确保深色模式下的按钮有足够的对比度 */
        [data-bs-theme="dark"] .btn-outline-secondary {
            color: #e2e8f0;
            border-color: #4a5568;
        }
        
        [data-bs-theme="dark"] .btn-outline-secondary:hover {
            background-color: #4a5568;
            color: #f8fafc;
        }
        
        /* 确保深色模式下的表单元素有足够的对比度 */
        [data-bs-theme="dark"] .form-control::placeholder {
            color: #a0aec0;
        }
    </style>
</head>
<body>
    {% if version_info and version_info.version != 'N/A' %}
    <div style="position: fixed; top: 5px; left: 5px; font-size: 0.75rem; color: grey; z-index: 9999; background-color: rgba(240, 240, 240, 0.8); padding: 5px; border-radius: 3px; max-width: 300px; line-height: 1.2;">
        <span>{{ version_info.last_update }} &nbsp; v{{ version_info.version }}</span><br>
        <span>{{ version_info.description | replace("维护开源环境！", "维护开源环境！<br>") | safe }}</span>
    </div>
    {% endif %}
    {% include 'navbar.html' %}
    
    <div class="container py-4">
        <div class="glass-panel mb-4">
            <h2>角色设定</h2>
            
            <!-- 添加获取人设按钮 -->
            <div class="d-flex justify-content-end mb-3">
                <button type="button" class="btn btn-lg btn-info" id="getAvatarBtn" title="获取人设">
                    <i class="bi bi-download me-2"></i>获取人设
                </button>
            </div>
            
            <!-- 添加人设选择器 -->
            <div class="avatar-selector">
                <label for="avatarSelector"><i class="bi bi-person-badge"></i>选择人设:</label>
                <select id="avatarSelector" class="form-select">
                    <!-- 这里的选项将通过JavaScript动态加载 -->
                </select>
                <button type="button" class="btn btn-outline-primary" id="newAvatarBtn" title="创建新人设">
                    <i class="bi bi-plus-circle"></i> 新建人设
                </button>
                <button type="button" class="btn btn-outline-danger" id="deleteAvatarBtn" title="删除当前人设">
                    <i class="bi bi-trash"></i> 删除人设
                </button>
            </div>
            <!-- 添加人物表情展示 -->
            <div class="avatar-selector" style="display: grid">
                <label for="avatarSelector" style="justify-content: space-between">
                    <div><i class="bi bi-person-badge"></i>表情展示:</div>
                    <button type="button" class="btn btn-lg btn-success" id="getAvatarEmojiBtn" title="上传压缩包">
                    <i class="bi bi-upload me-2"></i>上传压缩包
                    </button>
                </label>
                <div id="avatarEmojis">
                    <!-- 这里的表情将通过JavaScript动态加载 -->
                </div>

            </div>
            
            <form id="avatarForm">
                <div class="glass-panel mb-4">
                    <label for="task" class="form-label">任务</label>
                    <textarea class="form-control" id="task" name="task" rows="5" 
                        placeholder="请输入任务描述" title="任务描述" aria-label="任务描述"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="role" class="form-label">角色</label>
                    <textarea class="form-control" id="role" name="role" rows="5" 
                        placeholder="请输入角色设定" title="角色设定" aria-label="角色设定"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="appearance" class="form-label">外表</label>
                    <textarea class="form-control" id="appearance" name="appearance" rows="5" 
                        placeholder="请输入外表描述" title="外表描述" aria-label="外表描述"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="experience" class="form-label">经历</label>
                    <textarea class="form-control" id="experience" name="experience" rows="5" 
                        placeholder="请输入经历描述" title="经历描述" aria-label="经历描述"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="personality" class="form-label">性格</label>
                    <textarea class="form-control" id="personality" name="personality" rows="5" 
                        placeholder="请输入性格描述" title="性格描述" aria-label="性格描述"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="classic_lines" class="form-label">经典台词</label>
                    <textarea class="form-control" id="classic_lines" name="classic_lines" rows="5" 
                        placeholder="请输入经典台词" title="经典台词" aria-label="经典台词"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="preferences" class="form-label">喜好</label>
                    <textarea class="form-control" id="preferences" name="preferences" rows="5" 
                        placeholder="请输入喜好描述" title="喜好描述" aria-label="喜好描述"></textarea>
                </div>
                <div class="glass-panel mb-4">
                    <label for="notes" class="form-label">备注</label>
                    <textarea class="form-control" id="notes" name="notes" rows="5" 
                        placeholder="请输入备注信息" title="备注信息" aria-label="备注信息"></textarea>
                </div>
                <button type="button" class="btn btn-save" id="saveButton" title="保存角色设定">
                    <i class="bi bi-save me-2"></i>保存
                </button>
            </form>
        </div>
    </div>

    <!-- 新建人设模态框 -->
    <div class="modal fade" id="newAvatarModal" tabindex="-1" aria-labelledby="newAvatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newAvatarModalLabel">新建人设</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newAvatarName" class="form-label">人设名称</label>
                        <input type="text" class="form-control" id="newAvatarName" placeholder="请输入人设名称（英文）" required>
                        <small class="text-muted">请使用英文字母、数字和下划线，例如：ATRI、Mono_Chan</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="createAvatarBtn">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加删除确认模态框 -->
    <div class="modal fade" id="deleteAvatarModal" tabindex="-1" aria-labelledby="deleteAvatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAvatarModalLabel">删除人设</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    确定要删除这个人设吗？此操作不可恢复。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 添加删除确认人设表情模态框 -->
    <div class="modal fade" id="deleteAvatarEmojisModal" tabindex="-1" aria-labelledby="deleteAvatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteAvatarModalLabel">删除角色表情吗</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    确定要删除这个人的表情设吗？此操作不可恢复。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmEmojisDeleteBtn">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 获取人设模态框 -->
    <div class="modal fade" id="getAvatarModal" tabindex="-1" aria-labelledby="getAvatarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="getAvatarModalLabel">获取人设</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>请选择获取人设的方式：</p>
                    <div class="d-grid gap-2">
                        <a href="https://avatars.kourichat.com/#/" class="btn btn-primary" target="_blank">
                            前往官网下载
                        </a>
                        <a href="https://jq.qq.com/?_wv=1027&k=5F4Gz5K" class="btn btn-secondary" target="_blank">
                            加入QQ群 715616260 下载
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传表情包模态框 -->
    <div class="modal fade" id="getAvatarEmojiBtnModal" tabindex="-1" aria-labelledby="getAvatarEmojiBtnModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="getAvatarEmojiBtnModalLabel">上传表情包</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>压缩包必须包含以下文件夹：</p>
                    <ul>
                        <li>angry</li>
                        <li>happy</li>
                        <li>neutral</li>
                        <li>sad</li>
                    </ul>
                    <p>每个文件夹下的图片将作为表情展示。</p>
                    <form id="uploadForm" action="/upload_avatarEmoji_zip" method="post" enctype="multipart/form-data">
                        <div class="mb-3 d-grid">
{#                            <label for="formFile" class="form-label">上传压缩包</label>#}
                            <input class="form-control" type="file" id="formFile" name="file" accept="application/zip">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">上传</button>
                        </div>
                    </form>
                    <div class="progress d-none mb-3 mt-2">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 当前选中的人设目录
            let currentAvatar = 'MONO';
            let rawContent = ''; // 存储原始内容
            // 实例化JSZip对象
            let  zip = new JSZip();
            // 初始化背景
            fetch('/get_background')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.path) {
                        document.body.style.backgroundImage = `url('${data.path}')`;
                    }
                })
                .catch(error => console.error('Error:', error));
            
            // 获取可用的人设列表
            function loadAvatarList(newAvatarToSelect = null) {
                fetch('/get_available_avatars')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const selector = document.getElementById('avatarSelector');
                            selector.innerHTML = ''; // 清空现有选项
                            
                            // 打印获取到的人设列表，用于调试
                            console.log('获取到的人设列表:', data.avatars);
                            
                            // 添加人设选项
                            data.avatars.forEach(avatar => {
                                const option = document.createElement('option');
                                // 从路径中提取人设名称，确保一致的路径格式
                                let avatarName = avatar;
                                if (avatar.includes('/')) {
                                    avatarName = avatar.split('/').pop();
                                } else if (avatar.includes('\\')) {
                                    avatarName = avatar.split('\\').pop();
                                }
                                option.value = avatarName;
                                option.textContent = avatarName;
                                selector.appendChild(option);
                            });
                            
                            // 如果指定了要选择的新人设，则直接选择它
                            if (newAvatarToSelect && document.querySelector(`#avatarSelector option[value="${newAvatarToSelect}"]`)) {
                                selector.value = newAvatarToSelect;
                                currentAvatar = newAvatarToSelect;
                                loadAvatarContent(newAvatarToSelect);
                                return;
                            }
                            
                            // 否则按常规方式选择
                            if (data.avatars.length > 0) {
                                // 尝试从localStorage获取上次选择的人设
                                const lastSelected = localStorage.getItem('lastSelectedAvatar');
                                if (lastSelected && document.querySelector(`#avatarSelector option[value="${lastSelected}"]`)) {
                                    selector.value = lastSelected;
                                    currentAvatar = lastSelected;
                                } else {
                                    // 默认选择第一个
                                    const firstAvatarOption = selector.querySelector('option');
                                    if (firstAvatarOption) {
                                        const firstAvatar = firstAvatarOption.value;
                                        selector.value = firstAvatar;
                                        currentAvatar = firstAvatar;
                                    }
                                }
                                
                                // 加载选中人设的内容
                                loadAvatarContent(currentAvatar);
                            }
                        } else {
                            console.error('加载人设列表失败:', data.message);
                            showToast('加载人设列表失败: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('加载人设列表失败:', error);
                        showToast('加载人设列表失败: ' + error, 'error');
                    });
            }
            
            // 加载指定人设的内容
            function loadAvatarContent(avatarName) {
                fetch(`/load_avatar_content?avatar=${avatarName}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // 保存原始内容
                            rawContent = data.raw_content || '';

                            // 更新所有文本框的内容
                            const fields = ['task', 'role', 'appearance', 'experience',
                                          'personality', 'classic_lines', 'preferences', 'notes'];

                            fields.forEach(field => {
                                const element = document.getElementById(field);
                                if (element) {
                                    // 修改替换逻辑，确保所有 <br> 标签被替换为换行符
                                    element.value = (data.content[field] || '').replace(/<br\s*\/?>/g, '\n');
                                    // 自动调整文本框高度以适应内容
                                    element.style.height = 'auto';
                                    element.style.height = (element.scrollHeight) + 'px';
                                }
                            });

                            // 保存当前选择的人设到localStorage
                            localStorage.setItem('lastSelectedAvatar', avatarName);
                            currentAvatar = avatarName;

                            // 显示加载成功提示
                            showToast(`已加载 ${avatarName} 的角色设定`, 'success', 3000);

                            loadAvatarEmojis(avatarName);

                        } else {
                            console.error('加载人设内容失败:', data.message);
                            showToast('加载人设内容失败: ' + data.message, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('加载人设内容失败:', error);
                        showToast('加载人设内容失败: ' + error, 'error');
                    });
            }
            // 加载指定人设的表情包
            function loadAvatarEmojis(avatarName) {
                fetch(`/load_avatar_emojis?avatar=${avatarName}`,{
                    headers:{
                        //bolg: 设置请求头
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.status === 200) {

                        //解开压缩包文件
                        JSZip.loadAsync(response.blob())
                        .then(zip => {
                            // 解压缩出 'angry', 'happy', 'neutral', 'sad' 文件夹 每个文件夹下有图片
                            //映射'angry', 'happy', 'neutral', 'sad'中文
                            const emojiMap = {
                                'angry': '生气',
                                'happy': '开心',
                                'neutral': '中立',
                                'sad': '伤心'
                            }
                            let avatarEmojisDiv = document.getElementById('avatarEmojis')
                            avatarEmojisDiv.style.minHeight='670px'
                            //如果avatarEmojisDiv有子孩子就清空
                            if(avatarEmojisDiv.hasChildNodes()){
                                avatarEmojisDiv.innerHTML=''
                            }
                            // 确认删除表情按钮点击事件
                            //document.getElementById('confirmEmojisDeleteBtn').removeEventListener('click',deleteAvatarEmojiEvent)

                            zip.forEach((relativePath, zipEntry) => {
                                let folderNameDiv=null
                                let imgWrapList=null

                                // 获取文件夹名称进行分类
                                let folderName = relativePath.split('/')[0]
                                if (!document.getElementById(relativePath.split('/')[0])) {
                                    folderNameDiv=document.createElement('div')
                                    folderNameDiv.className='justify-content-center'
                                    folderNameDiv.innerHTML=`<h4>${emojiMap[folderName??'neutral']}</h4>`
                                    folderNameDiv.style.margin='10px'
                                    folderNameDiv.id=folderName
                                    imgWrapList= document.createElement('div')
                                    imgWrapList.style.display='flex'
                                    imgWrapList.style.flexWrap='wrap'
                                    imgWrapList.id=folderName
                                    folderNameDiv.appendChild(imgWrapList)
                                }else{
                                    folderNameDiv=document.getElementById(folderName)
                                    imgWrapList=folderNameDiv.childNodes[1]
                                }
                                // 如果文件夹名称不是表情包文件夹，则跳过
                                zipEntry.async('blob').then(function (content) {
                                    // 将图片添加到页面 id avatarEmojis
                                    const imgWrap= document.createElement('div')
                                    imgWrap.style.position='relative'
                                    imgWrap.style.width = '100px';
                                    imgWrap.style.height = '100px';
                                    imgWrap.style.margin='10px'
                                    const img = document.createElement('img');
                                    img.src = URL.createObjectURL(content);
                                    img.style.width = '100%';
                                    img.style.height = '100%';
                                    img.alt = relativePath.split('/')[1];
                                    imgWrap.appendChild(img)
                                    //img右上角加入删除图标
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.className = 'btn btn-outline-danger btn-sm';
                                    deleteBtn.innerHTML = `<i class="bi bi-x-octagon" style="font-size: 16px" id="${relativePath}"></i>`;
                                    deleteBtn.title = '删除表情';
                                    deleteBtn.style.position = 'absolute';
                                    deleteBtn.style.top = '0';
                                    deleteBtn.style.right = '0';
                                    deleteBtn.style.height= '30px'
                                    deleteBtn.style.border='none'
                                    deleteBtn.style.padding='5px'
                                    deleteBtn.style.display=''
                                    deleteBtn.id='BtnDelete_'+relativePath
                                    deleteBtn.addEventListener('click', function() {
                                        const modal = new bootstrap.Modal(document.getElementById('deleteAvatarEmojisModal'));
                                        //往confirmEmojisDeleteBtn绑定属性
                                        const modalDom=document.getElementById('confirmEmojisDeleteBtn')
                                        modalDom.setAttribute('data-url',relativePath)
                                        modal.show();
                                    })
                                    imgWrap.appendChild(deleteBtn);
                                    imgWrapList.appendChild(imgWrap)
                                })
                                avatarEmojisDiv.appendChild(folderNameDiv)
                            })
                        })

                    } else {
                        throw new Error('加载表情包失败: ' + response.statusText);
                    }
                })

                .catch(error => {
                    console.error('加载人设内容失败:', error);
                    showToast('加载人设内容失败: ' + error, 'error');
                });
            }
            // 修改查看原始MD内容的功能
            function addViewRawButton() {
                // 在人设选择器旁添加一个按钮
                const selector = document.querySelector('.avatar-selector');
                const viewRawBtn = document.createElement('button');
                viewRawBtn.className = 'btn btn-outline-secondary';
                viewRawBtn.innerHTML = '<i class="bi bi-code-slash"></i> 查看原始MD';
                viewRawBtn.title = '查看原始Markdown内容';
                viewRawBtn.addEventListener('click', function() {
                    // 创建模态框
                    const modalDiv = document.createElement('div');
                    modalDiv.className = 'modal fade';
                    modalDiv.id = 'rawContentModal';
                    modalDiv.tabIndex = '-1';
                    modalDiv.setAttribute('aria-labelledby', 'rawContentModalLabel');
                    modalDiv.setAttribute('aria-hidden', 'true');
                    
                    // 检测当前是否为深色模式
                    const isDarkMode = document.body.getAttribute('data-bs-theme') === 'dark';
                    
                    modalDiv.innerHTML = `
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content ${isDarkMode ? 'bg-dark text-light' : ''}">
                                <div class="modal-header ${isDarkMode ? 'border-secondary' : ''}">
                                    <h5 class="modal-title" id="rawContentModalLabel">原始Markdown内容</h5>
                                    <button type="button" class="btn-close ${isDarkMode ? 'btn-close-white' : ''}" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-end mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="copyMdBtn">
                                                <i class="bi bi-clipboard"></i> 复制
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearMdBtn">
                                                <i class="bi bi-trash"></i> 清空
                                            </button>
                                        </div>
                                        <textarea class="form-control ${isDarkMode ? 'bg-dark text-light' : ''}" 
                                            id="rawMdContent" 
                                            style="min-height: 400px; font-family: monospace;"
                                        >${rawContent}</textarea>
                                    </div>
                                </div>
                                <div class="modal-footer ${isDarkMode ? 'border-secondary' : ''}">
                                    <button type="button" class="btn ${isDarkMode ? 'btn-outline-light' : 'btn-secondary'}" data-bs-dismiss="modal">取消</button>
                                    <button type="button" class="btn btn-primary" id="saveMdBtn">保存修改</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modalDiv);
                    
                    // 显示模态框
                    const modal = new bootstrap.Modal(modalDiv);
                    modal.show();
                    
                    // 复制按钮功能
                    document.getElementById('copyMdBtn').addEventListener('click', function() {
                        const textarea = document.getElementById('rawMdContent');
                        textarea.select();
                        document.execCommand('copy');
                        showToast('内容已复制到剪贴板', 'success');
                    });
                    
                    // 清空按钮功能
                    document.getElementById('clearMdBtn').addEventListener('click', function() {
                        if(confirm('确定要清空所有内容吗？此操作不可恢复。')) {
                            document.getElementById('rawMdContent').value = '';
                            showToast('内容已清空', 'success');
                        }
                    });
                    
                    // 保存修改按钮功能
                    document.getElementById('saveMdBtn').addEventListener('click', function() {
                        const newContent = document.getElementById('rawMdContent').value;
                        const avatarData = {
                            avatar: currentAvatar,
                            content: newContent
                        };
                        
                        fetch('/save_avatar_raw', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(avatarData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // 如果有警告信息，以"成功但有警告"的方式显示
                                if (data.warning) {
                                    showToast('修改已保存，但有警告: ' + data.warning, 'warning');
                                } else {
                                    showToast('修改已保存', 'success');
                                }
                                modal.hide();
                                // 重新加载内容
                                loadAvatarContent(currentAvatar);
                            } else if (data.status === 'partial_success') {
                                // 处理部分成功的情况
                                showToast('修改部分保存: ' + data.message, 'warning');
                                modal.hide();
                                loadAvatarContent(currentAvatar);
                            } else {
                                showToast('保存失败: ' + data.message, 'error');
                            }
                        })
                        .catch(error => {
                            console.error('保存人设原始内容出错:', error);
                            showToast('保存失败: ' + error, 'error');
                        });
                    });
                    
                    // 模态框关闭后移除DOM
                    modalDiv.addEventListener('hidden.bs.modal', function() {
                        document.body.removeChild(modalDiv);
                    });
                });
                
                selector.appendChild(viewRawBtn);
            }
            
            // 监听人设选择器变化
            document.getElementById('avatarSelector').addEventListener('change', function() {
                const selectedAvatar = this.value;
                if (selectedAvatar !== currentAvatar) {
                    loadAvatarContent(selectedAvatar);
                }
            });
            
            // 保存按钮点击事件
            document.getElementById('saveButton').addEventListener('click', function() {
                const avatarData = {
                    avatar: currentAvatar, // 添加当前人设名称
                    task: document.getElementById('task').value.replace(/<br\s*\/?>/g, '\n'),
                    role: document.getElementById('role').value.replace(/<br\s*\/?>/g, '\n'),
                    appearance: document.getElementById('appearance').value.replace(/<br\s*\/?>/g, '\n'),
                    experience: document.getElementById('experience').value.replace(/<br\s*\/?>/g, '\n'),
                    personality: document.getElementById('personality').value.replace(/<br\s*\/?>/g, '\n'),
                    classic_lines: document.getElementById('classic_lines').value.replace(/<br\s*\/?>/g, '\n'),
                    preferences: document.getElementById('preferences').value.replace(/<br\s*\/?>/g, '\n'),
                    notes: document.getElementById('notes').value.replace(/<br\s*\/?>/g, '\n')
                };

                console.log('准备发送的数据:', avatarData);  // 调试信息

                fetch('/save_avatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(avatarData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === 'success') {
                        // 如果有警告信息，以"成功但有警告"的方式显示
                        if (data.warning) {
                            showToast('角色设定已保存，但有警告: ' + data.warning, 'warning');
                        } else {
                            showToast('角色设定已成功保存', 'success');
                        }
                        // 重新加载内容以获取最新的原始MD
                        loadAvatarContent(currentAvatar);
                    } else if (data.status === 'partial_success') {
                        // 处理部分成功的情况
                        showToast('角色设定部分保存: ' + data.message, 'warning');
                        loadAvatarContent(currentAvatar);
                    } else {
                        showToast('保存失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('保存角色设定出错:', error);
                    showToast('保存失败: ' + error, 'error');
                });
            });

            // 为所有文本框添加自动调整高度的功能
            document.querySelectorAll('textarea.form-control').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });
            
            // 显示提示消息
            function showToast(message, type = 'success') {
                // 确保消息是字符串，处理复杂对象
                let messageStr;
                try {
                    if (message instanceof Error) {
                        messageStr = message.message || "未知错误";
                    } else if (typeof message === 'object') {
                        messageStr = JSON.stringify(message).substring(0, 100);
                    } else {
                        messageStr = String(message);
                    }
                } catch (e) {
                    messageStr = "显示错误信息时出错";
                    console.error("处理Toast消息时出错:", e);
                }
                
                // 决定显示的样式
                let toastClass;
                switch(type) {
                    case 'success':
                        toastClass = 'bg-success';
                        break;
                    case 'warning':
                        toastClass = 'bg-warning text-dark';
                        break;
                    case 'error':
                        toastClass = 'bg-danger';
                        break;
                    default:
                        toastClass = 'bg-primary';
                }
                
                const toast = document.createElement('div');
                toast.className = 'toast-container position-fixed top-0 start-50 translate-middle-x p-3';
                toast.innerHTML = `
                    <div class="toast align-items-center text-white ${toastClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                <i class="bi bi-${type === 'success' ? 'check-circle' : (type === 'warning' ? 'exclamation-circle' : 'x-circle')} me-2"></i>${messageStr}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                    </div>
                `;
                document.body.appendChild(toast);
                const toastEl = toast.querySelector('.toast');
                const bsToast = new bootstrap.Toast(toastEl, {
                    delay: 5000  // 增加显示时间，让用户有更多时间看到消息
                });
                bsToast.show();
                
                // 自动移除 toast
                toastEl.addEventListener('hidden.bs.toast', function () {
                    toast.remove();
                });
            }
            
            // 加载人设列表
            loadAvatarList();
            
            // 添加查看原始MD内容的按钮
            addViewRawButton();

            // 新建人设按钮点击事件
            document.getElementById('newAvatarBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('newAvatarModal'));
                modal.show();
            });

            // 创建人设按钮点击事件
            document.getElementById('createAvatarBtn').addEventListener('click', function() {
                const avatarName = document.getElementById('newAvatarName').value.trim();
                
                if (!avatarName) {
                    showToast('请输入人设名称', 'error');
                    return;
                }

                if (!/^[a-zA-Z0-9_]+$/.test(avatarName)) {
                    showToast('人设名称只能包含英文字母、数字和下划线', 'error');
                    return;
                }

                // 禁用创建按钮，防止重复点击
                document.getElementById('createAvatarBtn').disabled = true;
                
                fetch('/create_avatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ avatar_name: avatarName })
                })
                .then(response => {
                    // 无论响应状态如何，都尝试解析JSON
                    return response.json().catch(e => {
                        // 如果JSON解析失败，返回一个默认对象，仍标记为成功
                        console.warn("响应解析失败，但将继续处理:", e);
                        return { status: 'success', warning: '响应解析失败，但人设可能已创建成功' };
                    });
                })
                .then(data => {
                    if (data.status === 'success' || data.status === 'partial_success') {
                        // 无论是成功还是部分成功，都视为创建成功
                        let message = '人设创建成功';
                        let type = 'success';
                        
                        if (data.warning) {
                            message += '，但有警告: ' + data.warning;
                            type = 'warning';
                        } else if (data.status === 'partial_success') {
                            message = '人设部分创建成功: ' + (data.message || '');
                            type = 'warning';
                        }
                        
                        showToast(message, type);
                        
                        // 关闭模态框
                        bootstrap.Modal.getInstance(document.getElementById('newAvatarModal')).hide();
                        
                        // 清空输入框
                        document.getElementById('newAvatarName').value = '';
                        
                        // 使用改进的加载策略，直接指定要选择的新人设
                        console.log("尝试加载并选择新创建的人设:", avatarName);
                        
                        // 延迟加载，给服务器一些处理时间
                        setTimeout(() => {
                            // 传入新创建的人设名称，让loadAvatarList自动选中它
                            loadAvatarList(avatarName);
                            
                            // 再次检查，确保人设被正确加载
                            setTimeout(() => {
                                if (!document.querySelector(`#avatarSelector option[value="${avatarName}"]`)) {
                                    console.log("第一次加载未找到新人设，重新尝试...");
                                    loadAvatarList(avatarName);
                                    
                                    // 最后一次尝试
                                    setTimeout(() => {
                                        if (!document.querySelector(`#avatarSelector option[value="${avatarName}"]`)) {
                                            console.log("多次尝试后仍未找到新人设，进行最终尝试");
                                            loadAvatarList();
                                        }
                                    }, 1500);
                                }
                            }, 1500);
                        }, 1000);
                    } else {
                        pass
                    }
                    // 重新启用创建按钮
                    document.getElementById('createAvatarBtn').disabled = false;
                })
                .catch(error => {
                    console.error('创建人设出错，但将尝试继续:', error);
                    showToast('人设创建成功，载入中...', 'success', 3000);
                    
                    // 即使出错也尝试关闭模态框和重新加载人设列表
                    try {
                        bootstrap.Modal.getInstance(document.getElementById('newAvatarModal')).hide();
                        document.getElementById('newAvatarName').value = '';
                        
                        // 延迟尝试加载人设列表
                        setTimeout(() => {
                            loadAvatarList(avatarName);  // 尝试直接加载并选择新人设
                            
                            // 检查结果，必要时再次尝试
                            setTimeout(() => {
                                if (!document.querySelector(`#avatarSelector option[value="${avatarName}"]`)) {
                                    loadAvatarList();  // 回退到常规加载
                                }
                            }, 2000);
                        }, 1000);
                    } catch (e) {
                        console.error("清理UI时出错:", e);
                    }
                    
                    // 重新启用创建按钮
                    document.getElementById('createAvatarBtn').disabled = false;
                });
            });

            // 删除人设按钮点击事件
            document.getElementById('deleteAvatarBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('deleteAvatarModal'));
                modal.show();
            });

            // 确认删除表情按钮点击事件
            function  deleteAvatarEmojiEvent  (event) {
                const avatarName = document.getElementById('avatarSelector').value;
                // 把 / 全部替换成 \
                const imgUrl = event.target.dataset.url?.replace(/\//g, '\\');

                fetch('/delete_avatar_emojis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ avatar_name: avatarName, img_url: imgUrl })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('表情已删除', 'success');
                        // 关闭模态框
                        bootstrap.Modal.getInstance(document.getElementById('deleteAvatarEmojisModal')).hide();
                        //获取全部Button id开头为BtnDelete 的按钮 样式关闭
                        let btnDeleteList=document.querySelectorAll('button[id^="BtnDelete"]')
                        btnDeleteList.forEach(btn=>{
                            if(btn.id.split('BtnDelete')[1]===imgUrl){
                                btn.style.display='none'
                            }
                        })
                        // 重新加载人设列表
                        loadAvatarEmojis(avatarName);
                    } else {
                        showToast('删除失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('删除失败: ' + error, 'error');
                });
            }
            document.getElementById('confirmEmojisDeleteBtn').addEventListener('click', deleteAvatarEmojiEvent);

            // 确认删除按钮点击事件
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                const avatarName = document.getElementById('avatarSelector').value;
                
                fetch('/delete_avatar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ avatar_name: avatarName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('人设已删除', 'success');
                        // 关闭模态框
                        bootstrap.Modal.getInstance(document.getElementById('deleteAvatarModal')).hide();
                        // 重新加载人设列表
                        loadAvatarList();
                    } else {
                        showToast('删除失败: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('删除失败: ' + error, 'error');
                });
            });

            // 获取人设按钮点击事件
            document.getElementById('getAvatarBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('getAvatarModal'));
                modal.show();
            });
            // 上传表情包按钮点击事件
            document.getElementById('getAvatarEmojiBtn').addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('getAvatarEmojiBtnModal'));
                modal.show();
            });
            document.getElementById("uploadForm").addEventListener("submit", function(e) {
                e.preventDefault();
                // 获取表单中的文件对象
                const formData = new FormData(this);
                const file = formData.get("file");
                //检查文件是否存在
                if (!file) {
                    showToast("请选择文件", "error");
                    return;
                }
                // 检查文件是否为zip文件
                if (!file.name.endsWith(".zip")) {
                    showToast("请选择zip文件", "error");
                    return;
                }
                //文件大小不超过20M
                if (file.size > 20 * 1024 * 1024) {
                    showToast("文件大小不能超过20M", "error");
                    return;
                }
                //设置文件名为avatar_name
                formData.append('avatar_name', currentAvatar);
                // 创建一个XMLHttpRequest对象
                const xhr = new XMLHttpRequest();
                xhr.open("POST", this.action, true);

                xhr.upload.addEventListener("progress", (event) => {
                if (event.lengthComputable) {
                    const percent = (event.loaded / event.total) * 100;
                    document.querySelector(".progress-bar").style.width = `${percent}%`;
                    document.querySelector(".progress-bar").textContent = `${Math.round(percent)}%`;
                    document.querySelector(".progress").classList.remove("d-none");
                }
            });

            xhr.onload = () => {
            if (xhr.status === 200) {
                    showToast('上传成功！')
                    //清空上传表单
                    document.getElementById("uploadForm").reset();
                    //关闭模态框
                    bootstrap.Modal.getInstance(document.getElementById('getAvatarEmojiBtnModal')).hide();
                    // 重新加载人设列表
                    loadAvatarEmojis(currentAvatar);
                } else {
                    showToast(xhr.responseText, 'error');
                    bootstrap.Modal.getInstance(document.getElementById('getAvatarEmojiBtnModal')).hide();
                }
            document.querySelector(".progress").classList.add("d-none");document.querySelector(".progress-bar").style.width = "0%";};

            xhr.send(formData);
});

        });
    </script>
</body>
</html>
