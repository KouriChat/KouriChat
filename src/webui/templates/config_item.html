<style>
    .form-label {
        transition: all 0.3s ease;
    }
    
    .form-label:hover {
        color: var(--primary-color);
    }
    
    .badge {
        transition: all 0.3s ease;
    }
    
    .badge:hover {
        transform: scale(1.1);
    }
    
    /* 列表项动画 */
    .list-group-item {
        transition: all 0.3s ease;
    }
    
    .list-group-item:hover {
        transform: translateX(5px);
        background: rgba(var(--bs-primary-rgb), 0.1);
    }
    
    /* 按钮动画 */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    /* 输入框动画 */
    .form-control {
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* 移除遮罩相关样式 */
    .modal-backdrop-custom {
        display: none !important;
    }

    /* 修改模态框样式 */
    .time-picker-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        display: none;
        transition: opacity 0.3s ease;
        opacity: 0;
    }

    .time-picker-modal.show {
        opacity: 1;
    }

    .time-picker-content {
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }

    .time-picker-modal.show .time-picker-content {
        transform: scale(1);
    }

    /* 添加时间显示输入框的点击反馈效果 */
    .time-display {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .time-display:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .time-display:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* 修改时间选项的悬停和选中效果 */
    .time-option-{{ key }} {
        padding: 8px 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 15px;
        border-radius: 8px;
        margin: 2px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .time-option-{{ key }}:hover {
        background-color: rgba(var(--bs-primary-rgb), 0.1);
        transform: translateX(2px);
    }

    .time-option-{{ key }}.selected {
        background-color: var(--bs-primary);
        color: white;
        transform: scale(1.05);
    }

    .time-option-{{ key }}.clicking {
        transform: scale(0.95);
    }
</style>
<label class="form-label">
    <span class="badge badge-info rounded-pill me-2" 
        data-bs-toggle="tooltip" 
        title="{{ key }}">
        <i class="bi bi-info-circle"></i>
    </span>
    {{ config.description }}
</label>
{% if key == 'LISTEN_LIST' %}
    <!-- LISTEN_LIST 相关代码 -->
    <div class="mb-2">
        <div class="input-group mb-2">
            <input type="text" class="form-control" 
                id="input_{{ key }}" 
                placeholder="请输入要监听的用户">
            <button class="btn btn-primary" type="button" 
                onclick="addNewUser('{{ key }}')"
                title="添加用户">
                添加 <i class="bi bi-plus-lg"></i>
            </button>
        </div>
        <div id="selected_users_{{ key }}" class="list-group">
            {% if config.value %}
                {% for user in config.value %}
                    {% if user %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            {{ user }}
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeUser('{{ key }}', '{{ user }}')" title="删除用户">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <input type="text" class="form-control" 
        id="{{ key }}" name="{{ key }}" 
        value="{{ config.value|join(',') }}"
        placeholder="多个值用英文逗号分隔"
        readonly
        style="display: none;">
{% elif key == 'DEEPSEEK_BASE_URL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="api_provider_select" onchange="updateApiProvider(this.value)" aria-label="选择API提供商">
            <option value="">请选择API提供商</option>
            <option value="custom">自定义API提供商</option>
        </select>

        <!-- 添加自定义 API 输入框 -->
        <div id="customApiInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                   placeholder="请输入自定义 API 地址"
                   onchange="updateCustomApi(this.value)">
        </div>

        <!-- 注册链接容器 -->
        <div id="register_links" class="d-none">
            <!-- 注册链接将通过JavaScript动态添加 -->
        </div>

        <input type="text" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}"
            readonly
            style="display: none;">
    </div>

    <script>
    let modelConfigs = null;
    
    // 获取配置数据
    async function fetchModelConfigs() {
        try {
            const response = await fetch('/get_model_configs');
            const data = await response.json();
            modelConfigs = data;
            initializeSelects();
        } catch (error) {
            console.error('获取配置失败:', error);
        }
    }

    // 初始化选择框
    function initializeSelects() {
        if (!modelConfigs) return;

        // 初始化API提供商选择框
        const apiSelect = document.getElementById('api_provider_select');
        apiSelect.innerHTML = '<option value="">请选择API提供商</option>';
        
        // 按优先级排序并添加选项
        modelConfigs.api_providers
            .sort((a, b) => a.priority - b.priority)
            .forEach(provider => {
                if (provider.status === 'active') {
                    apiSelect.innerHTML += `<option value="${provider.id}" 
                        data-url="${provider.url}"
                        data-register="${provider.register_url}"
                        >${provider.name}</option>`;
                }
            });
            
        apiSelect.innerHTML += '<option value="custom">自定义API提供商</option>';

        // 根据当前配置设置初始值
        const currentUrl = document.getElementById('DEEPSEEK_BASE_URL').value;
        
        // 优先选择KouriChat API
        if (currentUrl && (currentUrl.includes('kourichat.com') || currentUrl.includes('ciallo.ac.cn'))) {
            // 尝试找到匹配的KouriChat提供商
            const kouriOptions = Array.from(apiSelect.options).filter(opt => 
                (opt.value === 'kourichat' || opt.value === 'ciallo') && 
                opt.dataset && opt.dataset.url && 
                (opt.dataset.url.includes(currentUrl) || currentUrl.includes(opt.dataset.url))
            );
            
            if (kouriOptions.length > 0) {
                // 找到匹配的选项
                apiSelect.value = kouriOptions[0].value;
            } else {
                // 没找到精确匹配的，默认选择kourichat
                apiSelect.value = 'kourichat';
            }
            
            // 触发更新
            updateApiProvider(apiSelect.value);
        } else {
            // 非KouriChat URL的处理方式
            const currentProvider = modelConfigs.api_providers.find(p => p.url === currentUrl);
            
            if (currentProvider) {
                apiSelect.value = currentProvider.id;
                updateApiProvider(currentProvider.id);
            } else if (currentUrl) {
                apiSelect.value = 'custom';
                showCustomApiInput(currentUrl);
            }
        }
    }

    // 显示自定义API输入框
    function showCustomApiInput(value = '') {
        const customApiInput = document.getElementById('customApiInput');
        customApiInput.style.display = 'block';
        const inputElement = customApiInput.querySelector('input');

        if (value) {
            inputElement.value = value;
        } else {
            // 清空输入框内容
            inputElement.value = ''; 
        }

        // 绑定输入框的 change 事件
        inputElement.onchange = function() {
            updateCustomApi(inputElement.value);
        };
    }
        // 更新模型选择框
    async function updateModelSelect(providerId) {
        // 更新模型选择框
        const modelSelect = document.getElementById('model_select');
        const modelInput = document.getElementById('MODEL');
        const customModelInput = document.getElementById('customModelInput');
        
        modelSelect.innerHTML = '<option value="">请选择模型</option>';

        if (providerId === 'custom') {
            modelSelect.innerHTML += '<option value="custom">自定义模型</option>';
            modelSelect.value = 'custom';
            customModelInput.style.display = 'block';
            const currentValue = modelInput.value;
            if (currentValue && currentValue !== 'custom') {
                customModelInput.querySelector('input').value = currentValue;
            }
            return;
        }

        if (!providerId) {
            modelInput.value = '';
            return;
        }

        try {
            // 如果是 Ollama，尝试获取本地模型列表
            if (providerId === 'ollama') {
                try {
                    const response = await fetch('http://localhost:11434/api/tags');
                    if (response.ok) {
                        const data = await response.json();
                        const ollamaModels = data.models || [];
                        ollamaModels.forEach(model => {
                            modelSelect.innerHTML += `
                                <option value="${model.name}" 
                                    data-type="chat"
                                    data-context-length="16000"
                                    >${model.name}</option>`;
                        });
                    }
                } catch (error) {
                    console.error('获取Ollama模型列表失败:', error);
                    // 如果获取失败，使用配置文件中的默认模型
                    const defaultModels = modelConfigs.models[providerId] || [];
                    defaultModels.forEach(model => {
                        if (model.status === 'active') {
                            modelSelect.innerHTML += `
                                <option value="${model.id}" 
                                    data-type="${model.type}"
                                    data-context-length="${model.context_length}"
                                    >${model.name}</option>`;
                        }
                    });
                }
            } else {
                // 其他提供商使用配置文件中的模型列表
                const providerModels = modelConfigs.models[providerId] || [];
                providerModels.forEach(model => {
                    if (model.status === 'active') {
                        modelSelect.innerHTML += `
                            <option value="${model.id}" 
                                data-type="${model.type}"
                                data-context-length="${model.context_length}"
                                >${model.name}</option>`;
                    }
                });
            }

            // 添加自定义选项
            modelSelect.innerHTML += '<option value="custom">自定义模型</option>';

            // 设置当前选中的模型
            const currentModel = modelInput.value;
            const modelOptions = Array.from(modelSelect.options);
            
            // 特殊处理KouriChat V3模型 - 优先匹配准确的名称或ID
            if (currentModel === 'KouriChat V3' || currentModel === 'kourichat-v3') {
                const kouriV3Option = modelOptions.find(option => 
                    option.value === 'kourichat-v3' || 
                    option.textContent.trim() === 'KouriChat V3'
                );
                
                if (kouriV3Option) {
                    modelSelect.value = kouriV3Option.value;
                    customModelInput.style.display = 'none';
                    return;
                }
            }
            
            // 检查当前值是否在预设选项中
            const modelExists = modelOptions.some(option => option.value === currentModel);

            if (modelExists) {
                modelSelect.value = currentModel;
                customModelInput.style.display = 'none';
            } else if (currentModel) {
                // 再次尝试匹配显示名称
                const optionByText = modelOptions.find(option => option.textContent.trim() === currentModel);
                if (optionByText) {
                    modelSelect.value = optionByText.value;
                    customModelInput.style.display = 'none';
                } else {
                    modelSelect.value = 'custom';
                    customModelInput.style.display = 'block';
                    customModelInput.querySelector('input').value = currentModel;
                }
            } else {
                // 如果没有当前模型，选择第一个可用的模型
                const firstModel = modelOptions.find(option => option.value && option.value !== 'custom');
                if (firstModel) {
                    modelSelect.value = firstModel.value;
                    modelInput.value = firstModel.value;
                    customModelInput.style.display = 'none';
                }
            }

            // 触发change事件
            const event = new Event('change', { bubbles: true });
            modelSelect.dispatchEvent(event);
            
        } catch (error) {
            console.error('更新模型选择失败:', error);
        }
    }

    // 更新模型
    function updateModel(value) {
        const modelInput = document.getElementById('MODEL');
        const customModelInput = document.getElementById('customModelInput');
        
        if (value === 'custom') {
            customModelInput.style.display = 'block';
            // 保持当前值不变，让用户可以编辑
            const currentValue = modelInput.value;
            if (currentValue && currentValue !== 'custom') {
                customModelInput.querySelector('input').value = currentValue;
            }
        } else {
            customModelInput.style.display = 'none';
            modelInput.value = value;
            // 触发change事件
            const event = new Event('change', { bubbles: true });
            modelInput.dispatchEvent(event);
        }
    }

    // 更新自定义模型
    function updateCustomModel(value) {
        const modelInput = document.getElementById('MODEL');
        if (value.trim()) {
            modelInput.value = value.trim();
            // 触发change事件
            const event = new Event('change', { bubbles: true });
            modelInput.dispatchEvent(event);
        }
    }
    // 更新API提供商
    function updateApiProvider(value) {
        const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
        const customApiInput = document.getElementById('customApiInput');
        const registerLinks = document.getElementById('register_links');
        const modelSelect = document.getElementById('model_select');
        const modelInput = document.getElementById('MODEL');

        // 重置所有状态
        customApiInput.style.display = 'none';
        registerLinks.classList.add('d-none');
        registerLinks.innerHTML = '';

        // 处理自定义选项
        if (value === 'custom') {
            showCustomApiInput();
            updateModelSelect('custom');
            // 当选择自定义时，清空API URL输入框
            baseUrlInput.value = ''; 
            return;
        }

        // 处理未选择情况
        if (!value) {
            updateModelSelect('');
            return;
        }

        // 获取选中的提供商配置
        const selectedOption = document.querySelector(`#api_provider_select option[value="${value}"]`);
        if (!selectedOption) return;

        // 更新API URL
        const apiUrl = selectedOption.dataset.url;
        baseUrlInput.value = apiUrl;
        
        // 添加标记是否为 Ollama
        if (value === 'ollama') {
            baseUrlInput.dataset.isOllama = 'true';
        } else {
            baseUrlInput.dataset.isOllama = 'false';
        }

        // 特殊处理KouriChat API
        if (value === 'kourichat' || value === 'ciallo') {
            // 直接设置模型为KouriChat V3
            modelInput.value = 'KouriChat V3';
        }

        // 创建注册按钮
        const registerUrl = selectedOption.dataset.register;
        if (registerUrl) {
            const link = document.createElement('a');
            link.href = registerUrl;
            link.className = 'btn btn-outline-primary w-100';
            link.target = '_blank';
            link.innerHTML = `<i class="bi bi-box-arrow-up-right me-1"></i>前往${selectedOption.textContent.replace(' API', '')}注册`;
            registerLinks.innerHTML = '';
            registerLinks.appendChild(link);
            registerLinks.classList.remove('d-none');
        }

        // 更新模型选择框
        updateModelSelect(value);
    }

    // 更新自定义API
    function updateCustomApi(value) {
        const baseUrlInput = document.getElementById('DEEPSEEK_BASE_URL');
        baseUrlInput.value = value;
    }

    // 页面加载时获取配置
    document.addEventListener('DOMContentLoaded', fetchModelConfigs);
    </script>
{% elif key == 'PROMPT_ENHANCEMENT' %}
    <!-- PROMPT_ENHANCEMENT 相关代码 -->
    <select class="form-select" id="{{ key }}" name="{{ key }}">
        <option value="True" {% if config.value %}selected{% endif %}>启用</option>
        <option value="False" {% if not config.value %}selected{% endif %}>停用</option>
    </select>
{% elif key == 'AVATAR_DIR' %}
    <!-- AVATAR_DIR 相关代码 -->
    <select class="form-select" id="{{ key }}" name="{{ key }}">
        {% for option in config.options %}
        <option value="{{ option }}" {% if option == config.value %}selected{% endif %}>
            {{ option.split('/')[-1] }}
        </option>
        {% endfor %}
    </select>

{% elif config.value is boolean %}
    <div class="form-check form-switch d-flex align-items-center" style="padding: 6px 0; min-height: 38px;">
        <input class="form-check-input me-2" type="checkbox" role="switch" 
            id="{{ key }}" name="{{ key }}" 
            {% if config.value %}checked{% endif %}
            style="margin: 0;">
        <label class="form-check-label mb-0" for="{{ key }}" style="line-height: 24px;">
            {{ '启用' if config.value else '停用' }}
        </label>
    </div>
{% elif key == 'MODEL' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="model_select" onchange="updateModel(this.value)" aria-label="选择模型">
            <option value="">请选择模型</option>
        </select>

        <!-- 添加自定义模型输入框 -->
        <div id="customModelInput" class="mb-2" style="display: none;">
            <input type="text" class="form-control" 
                    placeholder="请输入自定义模型名称"
                    onchange="updateCustomModel(this.value)"
                    value="{{ config.value }}">
        </div>

        <input type="hidden" class="form-control" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value }}">

        <script>
        function updateModel(value) {
            const modelInput = document.getElementById('MODEL');
            const customModelInput = document.getElementById('customModelInput');
            
            if (value === 'custom') {
                customModelInput.style.display = 'block';
                // 保持当前值不变，让用户可以编辑
                customModelInput.querySelector('input').value = modelInput.value;
            } else {
                customModelInput.style.display = 'none';
                modelInput.value = value;
            }
        }

        function updateCustomModel(value) {
            const modelInput = document.getElementById('MODEL');
            if (value.trim()) {
                modelInput.value = value.trim();
            }
        }

        // 初始化时检查是否需要显示自定义输入框
        document.addEventListener('DOMContentLoaded', function() {
            const modelSelect = document.getElementById('model_select');
            const currentModel = document.getElementById('MODEL').value;
            const customModelInput = document.getElementById('customModelInput');
            
            if (modelSelect && currentModel) {
                // 检查当前值是否在预设选项中
                const isPresetModel = Array.from(modelSelect.options).some(opt => opt.value === currentModel);
                if (!isPresetModel) {
                    modelSelect.value = 'custom';
                    customModelInput.style.display = 'block';
                    customModelInput.querySelector('input').value = currentModel;
                } else {
                    modelSelect.value = currentModel;
                    customModelInput.style.display = 'none';
                }
            }
        });
        </script>
    </div>
{% elif config.type == "number" %}
    {% if key == 'MAX_TOKEN' %}
        <style>
            .token-slider {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: #e2e8f0;
                outline: none;
                transition: all 0.3s ease;
            }
            
            .token-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #fff;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 0 4px rgba(0,0,0,0.2);
                border: 2px solid #0d6efd;
            }
            
            .token-slider::-moz-range-track {
                background: #e2e8f0;
                height: 8px;
                border-radius: 4px;
            }
            
            .token-slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #fff;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 0 4px rgba(0,0,0,0.2);
                border: 2px solid #0d6efd;
            }
            
            .token-slider::-webkit-slider-thumb:hover {
                background: #f8f9fa;
                box-shadow: 0 0 8px rgba(13,110,253,0.5);
                transform: scale(1.1);
            }
            
            .token-slider:active {
                opacity: 0.8;
            }
            
            .token-value {
                transition: all 0.2s ease;
            }
            .token-value.updating {
                color: #0d6efd;
                transform: scale(1.1);
            }
        </style>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>当前值: <strong id="{{ key }}_display" class="token-value">{{ config.value }}</strong></span>
            </div>
            <input type="range" 
                class="token-slider" 
                id="{{ key }}_slider" 
                min="50"
                max="5000"
                step="5"
                value="{{ config.value }}"
                oninput="updateToken('{{ key }}', this.value)"
                style="cursor: pointer;"
                title="最大token数滑动条">
            <div class="d-flex justify-content-between" style="color: #6c757d; font-size: 0.875rem;">
                <span>50</span>
                <span>5000</span>
            </div>
            <!-- 隐藏的实际提交值输入框 -->
            <input type="hidden" 
                id="{{ key }}" 
                name="{{ key }}" 
                value="{{ config.value }}">
        </div>

        <script>
            function updateToken(key, value) {
                // 将字符串转换为整数
                const numValue = parseInt(value);
                
                // 更新显示值
                const displayElement = document.getElementById(key + '_display');
                if (displayElement) {
                    displayElement.classList.add('updating');
                    displayElement.textContent = numValue;
                    setTimeout(() => {
                        displayElement.classList.remove('updating');
                    }, 300);
                }
                
                // 更新隐藏的实际提交值
                const inputElement = document.getElementById(key);
                if (inputElement) {
                    inputElement.value = numValue;
                }
            }
        </script>
    {% elif key == 'TEMPERATURE' %}
        <style>
            .temperature-slider {
                -webkit-appearance: none;
                appearance: none;
                width: 100%;
                height: 8px;
                border-radius: 4px;
                background: linear-gradient(to right, 
                    #3498db 0%,
                    #3498db 60%,
                    #9b59b6 70%,
                    #e74c3c 80%,
                    #e74c3c 100%
                );
                outline: none;
                transition: all 0.3s ease;
            }
            
            .temperature-slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #fff;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 0 4px rgba(0,0,0,0.2);
                border: 2px solid #0d6efd;
            }
            
            .temperature-slider::-moz-range-thumb {
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background: #fff;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 0 4px rgba(0,0,0,0.2);
                border: 2px solid #0d6efd;
            }
            
            .temperature-value {
                transition: all 0.2s ease;
            }
            .temperature-value.updating {
                color: #0d6efd;
                transform: scale(1.1);
            }
            
            .slider-labels {
                color: #6c757d;
                font-size: 0.875rem;
            }
            .slider-labels .low {
                color: #3498db;
            }
            .slider-labels .high {
                color: #e74c3c;
            }
        </style>
        
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span>当前值: <strong id="{{ key }}_display" class="temperature-value">{{ config.value }}</strong></span>
            </div>
            <input type="range" 
                class="temperature-slider" 
                id="{{ key }}_slider" 
                min="0.00"
                max="1.70"
                step="0.01"
                value="{{ config.value }}"
                oninput="updateTemperature('{{ key }}', this.value)"
                style="cursor: pointer;"
                title="温度参数滑动条">
            <div class="d-flex justify-content-between slider-labels">
                <span class="low">0.0</span>
                <span class="high">1.7</span>
            </div>
            <!-- 隐藏的实际提交值输入框 -->
            <input type="hidden" 
                id="{{ key }}" 
                name="{{ key }}" 
                value="{{ config.value }}">
        </div>

        <script>
            function updateTemperature(key, value) {
                // 将字符串转换为数字
                const numValue = parseFloat(value);
                
                // 更新显示值
                const displayElement = document.getElementById(key + '_display');
                if (displayElement) {
                    displayElement.classList.add('updating');
                    displayElement.textContent = numValue;
                    setTimeout(() => {
                        displayElement.classList.remove('updating');
                    }, 300);
                }
                
                // 更新隐藏的实际提交值
                const inputElement = document.getElementById(key);
                if (inputElement) {
                    inputElement.value = numValue;
                    // 触发 change 事件以确保表单能捕获到值的变化
                    const event = new Event('change', { bubbles: true });
                    inputElement.dispatchEvent(event);
                }

                // 调试输出
                console.log(`Temperature updated - key: ${key}, value: ${numValue}, type: ${typeof numValue}`);
                console.log(`Hidden input value: ${document.getElementById(key).value}`);
            }

            // 确保页面加载时初始化温度值
            document.addEventListener('DOMContentLoaded', function() {
                const slider = document.getElementById('{{ key }}_slider');
                if (slider) {
                    updateTemperature('{{ key }}', slider.value);
                }
            });
        </script>
    {% else %}
        <input type="number" 
            class="form-control" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}"
            step="0.1"
            {% if config.min is defined %}min="{{ config.min }}"{% endif %}
            {% if config.max is defined %}max="{{ config.max }}"{% endif %}>
    {% endif %}
{% elif key == 'DEEPSEEK_API_KEY' %}
    <input type="text" class="form-control" 
        id="{{ key }}" name="{{ key }}" 
        placeholder="sk-..."
        value="{{ config.value }}"
        autocomplete="new-password" 
        data-lpignore="true">
{% elif key == 'MOONSHOT_API_KEY' %}
    <div class="mb-3">
        <select class="form-select mb-2" id="image_api_provider_select" onchange="updateImageApiProvider(this.value)" aria-label="选择图像API提供商">
            <option value="">请选择API提供商</option>
            <option value="kourichat" data-url="https://api.kourichat.com/">KouriChat API (全球优化)</option>
            <option value="ciallo" data-url="https://api.ciallo.ac.cn/">KouriChat API (亚太备选)</option>
            <option value="moonshot" data-url="https://api.moonshot.cn/v1">Moonshot API</option>
            <option value="custom">自定义API提供商</option>
        </select>

        <!-- API密钥输入框，总是显示 -->
        <div class="mb-2">
            <input type="text" class="form-control" 
                   id="{{ key }}" name="{{ key }}" 
                   value="{{ config.value }}"
                   placeholder="请输入API密钥"
                   autocomplete="new-password" 
                   data-lpignore="true">
        </div>

        <!-- 自定义 API URL 输入框，仅在选择自定义时显示 -->
        <div id="customImageApiUrlInput" class="mb-2" style="display: none;">
            <label class="form-label">图像识别API基础URL</label>
            <input type="text" class="form-control" 
                   placeholder="请输入自定义 API 地址"
                   id="custom_image_api_url"
                   onchange="updateCustomImageApiUrl(this.value)">
        </div>

        <!-- 注册链接容器 -->
        <div id="image_register_links" class="mt-2">
            <a href="https://api.kourichat.com/" 
                class="btn btn-primary w-100"
                target="_blank"
                rel="noopener">
                <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
            </a>
        </div>

        <!-- 隐藏的API URL输入框 -->
        <input type="hidden" 
            id="MOONSHOT_BASE_URL" name="MOONSHOT_BASE_URL" 
            value="{{ config_groups['图像识别API配置']['MOONSHOT_BASE_URL'].value if '图像识别API配置' in config_groups and 'MOONSHOT_BASE_URL' in config_groups['图像识别API配置'] else '' }}">
    </div>

    <script>
    // 更新图像API提供商
    function updateImageApiProvider(value) {
        const apiKeyInput = document.getElementById('MOONSHOT_API_KEY');
        const apiUrlInput = document.getElementById('MOONSHOT_BASE_URL');
        const customApiUrlInput = document.getElementById('customImageApiUrlInput');
        const registerLinks = document.getElementById('image_register_links');
        
        // 根据选择的提供商设置注册链接和显示/隐藏自定义URL输入框
        if (value === 'custom') {
            // 显示自定义输入框
            customApiUrlInput.style.display = 'block';
            registerLinks.style.display = 'none';
            
            // 如果已有值，填入自定义输入框
            const currentApiUrl = apiUrlInput.value;
            if (currentApiUrl) {
                document.getElementById('custom_image_api_url').value = currentApiUrl;
            }
        } else {
            // 隐藏自定义输入框
            customApiUrlInput.style.display = 'none';
            registerLinks.style.display = 'block';
            
            // 根据选择的提供商设置API URL和注册链接
            const selectedOption = document.querySelector(`#image_api_provider_select option[value="${value}"]`);
            if (selectedOption && selectedOption.dataset.url) {
                apiUrlInput.value = selectedOption.dataset.url;
            }
            
            if (value === 'kourichat') {
                registerLinks.innerHTML = `
                    <a href="https://api.kourichat.com/" 
                       class="btn btn-primary w-100"
                       target="_blank"
                       rel="noopener">
                        <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
                    </a>
                `;
            } else if (value === 'ciallo') {
                registerLinks.innerHTML = `
                    <a href="https://api.ciallo.ac.cn/" 
                       class="btn btn-primary w-100"
                       target="_blank"
                       rel="noopener">
                        <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
                    </a>
                `;
            } else if (value === 'moonshot') {
                registerLinks.innerHTML = `
                    <a href="https://platform.moonshot.cn/console/api-keys" 
                       class="btn btn-primary w-100"
                       target="_blank"
                       rel="noopener">
                        <i class="bi bi-box-arrow-up-right me-1"></i>点我注册
                    </a>
                `;
            }
        }
        
        // 更新图像识别模型选择器状态
        if (typeof updateImageModelSelectors === 'function') {
            updateImageModelSelectors();
        }
    }
    
    // 更新自定义API URL
    function updateCustomImageApiUrl(value) {
        const apiUrlInput = document.getElementById('MOONSHOT_BASE_URL');
        apiUrlInput.value = value;
    }
    
    // 初始化时设置选择框的值
    document.addEventListener('DOMContentLoaded', function() {
        const apiKeyInput = document.getElementById('MOONSHOT_API_KEY');
        const apiUrlInput = document.getElementById('MOONSHOT_BASE_URL');
        const apiSelect = document.getElementById('image_api_provider_select');
        
        if (apiKeyInput && apiSelect) {
            // 尝试根据当前API URL判断选择哪个选项
            const currentApiUrl = apiUrlInput.value;
            let found = false;
            
            if (currentApiUrl) {
                // 检查是否匹配预设URL
                document.querySelectorAll('#image_api_provider_select option').forEach(option => {
                    if (option.dataset.url && currentApiUrl.includes(option.dataset.url)) {
                        apiSelect.value = option.value;
                        found = true;
                    }
                });
                
                if (!found) {
                    // 不是预设值，选择自定义
                    apiSelect.value = 'custom';
                }
            }
            
            // 如果没有选择任何值，默认选择kourichat
            if (!apiSelect.value) {
                apiSelect.value = 'kourichat';
            }
            
            // 触发change事件
            updateImageApiProvider(apiSelect.value);
        }
    });
    </script>
{% elif key == 'MOONSHOT_MODEL' %}
    <div class="mb-3" id="image_model_container">
        <div id="image_model_select_container" style="display: none;">
            <select class="form-select mb-2" id="image_model_select" onchange="updateImageModel(this.value)" aria-label="选择图像识别模型">
                <option value="">请选择图像识别模型</option>
                <option value="moonshot-v1-8k">Moonshot-v1-8k</option>
                <option value="moonshot-v1-32k">Moonshot-v1-32k</option>
                <option value="moonshot-v1-128k">Moonshot-v1-128k</option>
                <option value="custom">自定义模型</option>
            </select>

            <!-- 添加自定义模型输入框 -->
            <div id="customImageModelInput" class="mb-2" style="display: none;">
                <input type="text" class="form-control" 
                       placeholder="请输入自定义模型名称"
                       id="custom_image_model"
                       onchange="updateCustomImageModel(this.value)">
            </div>
        </div>

        <div id="kourichat_model_hint" class="text-muted">
            <p>使用KouriChat图像识别API时，默认使用Koala模型，无需手动选择。</p>
        </div>

        <input type="hidden" 
            id="{{ key }}" name="{{ key }}" 
            value="{{ config.value|default('koala', true) }}">
    </div>

    <script>
    // 根据所选的API提供商更新图像模型选择器的可见性
    function updateImageModelSelectors() {
        const apiSelect = document.getElementById('image_api_provider_select');
        const modelSelectContainer = document.getElementById('image_model_select_container');
        const kouriHint = document.getElementById('kourichat_model_hint');
        
        if (!apiSelect || !modelSelectContainer || !kouriHint) return;
        
        const selectedProvider = apiSelect.value;
        
        // 如果是moonshot或custom，显示模型选择器，隐藏默认文本
        if (selectedProvider === 'moonshot' || selectedProvider === 'custom') {
            modelSelectContainer.style.display = 'block';
            kouriHint.style.display = 'none';
        } else {
            // 否则隐藏模型选择器，显示默认文本
            modelSelectContainer.style.display = 'none';
            kouriHint.style.display = 'block';
            // 设置默认值为koala
            document.getElementById('{{ key }}').value = 'koala';
        }
        
        // 同时处理自定义模型输入框的可见性
        const modelSelect = document.getElementById('image_model_select');
        const customModelInput = document.getElementById('customImageModelInput');
        
        if (modelSelect && customModelInput && modelSelect.value === 'custom') {
            customModelInput.style.display = 'block';
        } else if (customModelInput) {
            customModelInput.style.display = 'none';
        }
    }
    
    // 更新图像识别模型
    function updateImageModel(value) {
        const modelInput = document.getElementById('{{ key }}');
        const customModelInput = document.getElementById('customImageModelInput');
        
        if (value === 'custom') {
            // 显示自定义输入框
            customModelInput.style.display = 'block';
            
            // 如果已有值，填入自定义输入框
            const currentModel = modelInput.value;
            if (currentModel && currentModel !== 'koala') {
                document.getElementById('custom_image_model').value = currentModel;
            }
        } else {
            // 隐藏自定义输入框
            customModelInput.style.display = 'none';
            modelInput.value = value;
        }
    }
    
    // 更新自定义模型
    function updateCustomImageModel(value) {
        const modelInput = document.getElementById('{{ key }}');
        modelInput.value = value;
    }
    
    // 初始化时设置选择框的值
    document.addEventListener('DOMContentLoaded', function() {
        const modelInput = document.getElementById('{{ key }}');
        const modelSelect = document.getElementById('image_model_select');
        
        if (modelInput && modelSelect) {
            const currentModel = modelInput.value;
            
            // 先等待API提供商选择器初始化完成
            setTimeout(() => {
                // 检查当前选择的API提供商
                const apiSelect = document.getElementById('image_api_provider_select');
                if (apiSelect) {
                    // 先更新模型选择器状态，根据API提供商决定是否显示
                    updateImageModelSelectors();
                    
                    // 然后如果需要显示模型选择框，再设置选中的值
                    if (apiSelect.value === 'moonshot' || apiSelect.value === 'custom') {
                        // 查找当前模型是否在预设中
                        const modelOption = Array.from(modelSelect.options).find(option => 
                            option.value === currentModel && option.value !== '' && option.value !== 'custom'
                        );
                        
                        if (modelOption) {
                            modelSelect.value = currentModel;
                        } else if (currentModel && currentModel !== 'koala') {
                            // 不在预设中且不是koala，设为自定义
                            modelSelect.value = 'custom';
                            document.getElementById('customImageModelInput').style.display = 'block';
                            document.getElementById('custom_image_model').value = currentModel;
                        } else {
                            // 默认选择第一个有效选项
                            modelSelect.value = 'moonshot-v1-8k';
                            modelInput.value = 'moonshot-v1-8k';
                        }
                    }
                    
                    // 监听API提供商选择变化
                    apiSelect.addEventListener('change', updateImageModelSelectors);
                }
            }, 100); // 短暂延迟确保API选择器已初始化
        }
    });
    </script>
{% elif key == 'MOONSHOT_TEMPERATURE' %}
    <div class="mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <span>当前值: <strong id="{{ key }}_display" class="temperature-value">{{ config.value }}</strong></span>
        </div>
        <input type="range" 
            class="temperature-slider" 
            id="{{ key }}_slider" 
            min="0.00"
            max="1.70"
            step="0.01"
            value="{{ config.value }}"
            oninput="updateImageTemperature('{{ key }}', this.value)"
            style="cursor: pointer;"
            title="温度参数滑动条">
        <div class="d-flex justify-content-between slider-labels">
            <span class="low">0.0 - 精确</span>
            <span class="high">1.7 - 创造性</span>
        </div>
        <!-- 隐藏的实际提交值输入框 -->
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
    </div>

    <style>
        .temperature-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                #3498db 0%,
                #3498db 60%,
                #9b59b6 70%,
                #e74c3c 80%,
                #e74c3c 100%
            );
            outline: none;
            transition: all 0.3s ease;
        }
        
        .temperature-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
            border: 2px solid #0d6efd;
        }
        
        .temperature-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
            border: 2px solid #0d6efd;
        }
        
        .temperature-value {
            transition: all 0.2s ease;
        }
        .temperature-value.updating {
            color: #0d6efd;
            transform: scale(1.1);
        }
        
        .slider-labels {
            color: #6c757d;
            font-size: 0.875rem;
        }
        .slider-labels .low {
            color: #3498db;
        }
        .slider-labels .high {
            color: #e74c3c;
        }
    </style>

    <script>
        function updateImageTemperature(key, value) {
            // 将字符串转换为数字
            const numValue = parseFloat(value);
            
            // 更新显示值
            const displayElement = document.getElementById(key + '_display');
            if (displayElement) {
                displayElement.classList.add('updating');
                displayElement.textContent = numValue;
                setTimeout(() => {
                    displayElement.classList.remove('updating');
                }, 300);
            }
            
            // 更新隐藏的实际提交值
            const inputElement = document.getElementById(key);
            if (inputElement) {
                inputElement.value = numValue;
                // 触发 change 事件以确保表单能捕获到值的变化
                const event = new Event('change', { bubbles: true });
                inputElement.dispatchEvent(event);
            }

            // 调试输出
            console.log(`Temperature updated - key: ${key}, value: ${numValue}, type: ${typeof numValue}`);
        }

        // 确保页面加载时初始化温度值
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('{{ key }}_slider');
            if (slider) {
                updateImageTemperature('{{ key }}', slider.value);
            }
        });
    </script>
{% elif key == 'QUIET_TIME_START' or key == 'QUIET_TIME_END' %}
    <div class="mb-3">
        <input type="text" 
            class="form-control time-display" 
            id="{{ key }}_display" 
            value="{{ config.value }}"
            readonly
            placeholder="请选择时间"
            onclick="showTimePicker_{{ key }}()">
        <input type="hidden" 
            id="{{ key }}" 
            name="{{ key }}" 
            value="{{ config.value }}">
            
        <!-- 时间选择器模态框 -->
        <div class="modal" id="timePickerModal_{{ key }}" tabindex="-1" aria-hidden="true" data-bs-backdrop="false">
            <div class="modal-dialog modal-dialog-centered" style="max-width: 300px;">
                <div class="modal-content time-picker-content">
                    <div class="modal-header border-bottom-0">
                        <h5 class="modal-title">
                            <i class="bi bi-clock me-2"></i>
                            选择{{ '开始时间' if key == 'QUIET_TIME_START' else '结束时间' }}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-0">
                        <div class="time-header-{{ key }} mb-3 text-center fs-4 fw-bold text-primary">
                            {{ config.value }}
                        </div>
                        <div class="time-columns-container-{{ key }}">
                            <div class="time-columns-{{ key }}">
                                <div class="time-column-{{ key }}">
                                    {% for h in range(24) %}
                                    <div class="time-option-{{ key }}" data-value="{{ '%02d' % h }}" onclick="selectTimeOption_{{ key }}('hour', '{{ '%02d' % h }}')">{{ '%02d' % h }}</div>
                                    {% endfor %}
                                </div>
                                <div class="time-column-{{ key }}">
                                    {% for m in range(0, 60, 1) %}
                                    <div class="time-option-{{ key }}" data-value="{{ '%02d' % m }}" onclick="selectTimeOption_{{ key }}('minute', '{{ '%02d' % m }}')">{{ '%02d' % m }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-top-0">
                        <button type="button" class="btn btn-light" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary px-4" onclick="confirmTimePicker_{{ key }}()">确定</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* 修改模态框对话框的宽度和样式 */
        .modal {
            background: none !important;
        }
        
        .modal-backdrop {
            display: none !important;
        }
        
        .time-picker-content {
            border-radius: 16px !important;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background: var(--bs-modal-bg);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }
        
        .modal.show .time-picker-content {
            transform: scale(1);
        }
        
        .modal .time-picker-content {
            transform: scale(0.95);
        }
        
        /* 修改时间选择器容器样式 */
        .time-columns-{{ key }} {
            display: flex;
            height: 200px;
            overflow: hidden;
            background: var(--bs-modal-bg);
            border-radius: 12px;
            padding: 8px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            width: 100%; /* 确保宽度100% */
        }
        
        .time-columns-{{ key }} {
            display: flex;
            gap: 12px; /* 添加列之间的间距 */
            padding: 0 12px; /* 增加左右内边距 */
        }
        
        .time-column-{{ key }} {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden; /* 禁止横向滚动 */
            text-align: center;
            scrollbar-width: thin;
            padding: 0 4px;
            position: relative;
            min-width: 0; /* 防止内容溢出 */
        }
        
        /* 修改分隔符样式 */
        .time-column-{{ key }}:first-child::after {
            content: ':';
            position: absolute;
            right: -8px; /* 调整位置 */
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: var(--bs-primary);
            font-weight: bold;
        }
        
        /* 调整选项样式 */
        .time-option-{{ key }} {
            padding: 8px 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
            border-radius: 8px;
            margin: 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .time-option-{{ key }}:hover {
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            transform: translateX(2px);
        }

        .time-option-{{ key }}.selected {
            background-color: var(--bs-primary);
            color: white;
            transform: scale(1.05);
        }
        
        /* 调整模态框内容边距 */
        .modal-body {
            padding: 1rem 1rem !important; /* 减小内边距 */
        }
        
        /* 调整头部和底部按钮区域的内边距 */
        .modal-header, .modal-footer {
            padding: 1rem !important;
        }
        
        /* 优化时间显示 */
        .time-header-{{ key }} {
            font-size: 2rem !important; /* 增大字号 */
            letter-spacing: 2px; /* 增加字间距 */
        }
    </style>
    
    <script>
        let timeSelection_{{ key }} = {
            hour: '{{ (config.value|string).split(":")[0] if ":" in (config.value|string) else "00" }}',
            minute: '{{ (config.value|string).split(":")[1] if ":" in (config.value|string) and (config.value|string).split(":")|length > 1 else "00" }}'
        };
        
        // 修改显示时间选择器的函数
        function showTimePicker_{{ key }}() {
            const modal = document.getElementById('timePickerModal_{{ key }}');
            
            // 计算页面中心位置
            const windowHeight = window.innerHeight;
            const modalHeight = 400;
            const scrollPosition = window.pageYOffset;
            const targetScrollPosition = scrollPosition + (windowHeight - modalHeight) / 2;

            // 平滑滚动到目标位置
            window.scrollTo({
                top: targetScrollPosition,
                behavior: 'smooth'
            });

            // 显示模态框
            setTimeout(() => {
                modal.style.display = 'block';
                requestAnimationFrame(() => modal.classList.add('show'));
            }, 300);

            // 初始化选择状态
            const currentInput = document.getElementById('{{ key }}');
            if (currentInput) {
                let currentValue = currentInput.value;
                if (currentValue) {
                    // 处理可能的非字符串格式（当值直接从后端传递时）
                    currentValue = String(currentValue);
                    
                    // 格式化时间值
                    if (!currentValue.includes(':')) {
                        // 尝试将纯数字格式转换为时间格式
                        if (/^\d+$/.test(currentValue)) {
                            if (currentValue.length === 4) {
                                // 如 "2200" -> "22:00"
                                currentValue = `${currentValue.substring(0, 2)}:${currentValue.substring(2, 4)}`;
                            } else if (currentValue.length === 3) {
                                // 如 "900" -> "09:00"
                                currentValue = `0${currentValue.substring(0, 1)}:${currentValue.substring(1, 3)}`;
                            } else if (currentValue.length === 2) {
                                // 如 "23" -> "23:00"
                                currentValue = `${currentValue}:00`;
                            } else if (currentValue.length === 1) {
                                // 如 "9" -> "09:00"
                                currentValue = `0${currentValue}:00`;
                            }
                        }
                    }
                    
                    // 更新显示值
                    document.getElementById('{{ key }}_display').value = currentValue;
                    document.getElementById('{{ key }}').value = currentValue;
                    
                    // 更新选中状态
                    const [hour, minute] = currentValue.includes(':') ? currentValue.split(':') : [currentValue, '00'];
                    timeSelection_{{ key }}.hour = hour || '00';
                    timeSelection_{{ key }}.minute = minute || '00';
                    
                    highlightSelectedTime_{{ key }}();
                    scrollToSelected_{{ key }}();
                }
            }
        }
        
        // 选择时间选项
        function selectTimeOption_{{ key }}(type, value) {
            const clickedOption = event.target;
            clickedOption.classList.add('clicking');
            
            timeSelection_{{ key }}[type] = value;
            updateTimeDisplay_{{ key }}();
            
            // 移除点击效果并更新选中状态
            setTimeout(() => {
                clickedOption.classList.remove('clicking');
                highlightSelectedTime_{{ key }}();
            }, 200);
        }
        
        // 更新时间显示
        function updateTimeDisplay_{{ key }}() {
            const timeString = `${timeSelection_{{ key }}.hour}:${timeSelection_{{ key }}.minute}`;
            document.querySelector('.time-header-{{ key }}').textContent = timeString;
        }
        
        // 高亮选中的时间
        function highlightSelectedTime_{{ key }}() {
            const columns = document.querySelectorAll('.time-column-{{ key }}');
            
            document.querySelectorAll('.time-option-{{ key }}').forEach(option => {
                option.classList.remove('selected');
            });
            
            if (columns[0]) {
                const hourOption = columns[0].querySelector(`.time-option-{{ key }}[data-value="${timeSelection_{{ key }}.hour}"]`);
                if (hourOption) hourOption.classList.add('selected');
            }
            
            if (columns[1]) {
                const minuteOption = columns[1].querySelector(`.time-option-{{ key }}[data-value="${timeSelection_{{ key }}.minute}"]`);
                if (minuteOption) minuteOption.classList.add('selected');
            }
        }
        
        // 滚动到选中位置
        function scrollToSelected_{{ key }}() {
            const columns = document.querySelectorAll('.time-column-{{ key }}');
            
            if (columns[0]) {
                const hourOption = columns[0].querySelector(`.time-option-{{ key }}[data-value="${timeSelection_{{ key }}.hour}"]`);
                if (hourOption) {
                    columns[0].scrollTop = hourOption.offsetTop - columns[0].offsetHeight / 2 + hourOption.offsetHeight / 2;
                }
            }
            
            if (columns[1]) {
                const minuteOption = columns[1].querySelector(`.time-option-{{ key }}[data-value="${timeSelection_{{ key }}.minute}"]`);
                if (minuteOption) {
                    columns[1].scrollTop = minuteOption.offsetTop - columns[1].offsetHeight / 2 + minuteOption.offsetHeight / 2;
                }
            }
        }
        
        // 简化关闭时间选择器的函数
        function closeTimePicker_{{ key }}() {
            const modal = document.getElementById('timePickerModal_{{ key }}');
            modal.classList.remove('show');
            
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        // 简化确认时间选择的函数
        function confirmTimePicker_{{ key }}() {
            const timeString = `${timeSelection_{{ key }}.hour}:${timeSelection_{{ key }}.minute}`;
            document.getElementById('{{ key }}_display').value = timeString;
            document.getElementById('{{ key }}').value = timeString;
            closeTimePicker_{{ key }}();
        }
        
        // 添加关闭按钮事件监听
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.querySelector('#timePickerModal_{{ key }} .btn-close');
            const cancelBtn = document.querySelector('#timePickerModal_{{ key }} .btn-light');
            
            if (closeBtn) {
                closeBtn.onclick = () => closeTimePicker_{{ key }}();
            }
            if (cancelBtn) {
                cancelBtn.onclick = () => closeTimePicker_{{ key }}();
            }
        });
    </script>
{% elif key == 'MOONSHOT_BASE_URL' %}
    <!-- 已经整合到MOONSHOT_API_KEY配置项中，保持隐藏字段以兼容后端逻辑 -->
    <input type="hidden" 
        id="{{ key }}" name="{{ key }}" 
        value="{{ config.value }}">
{% else %}
    <input type="text" class="form-control" 
        id="{{ key }}" name="{{ key }}" 
        value="{{ config.value }}">
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 检查 localStorage 中的状态
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'enabled') {
            document.body.setAttribute('data-bs-theme', 'dark');
            document.getElementById('darkModeToggle').checked = true; // 更新按钮状态
        }

        // 护眼模式切换
        document.getElementById('darkModeToggle').addEventListener('change', function() {
            if (this.checked) {
                document.body.setAttribute('data-bs-theme', 'dark');
                localStorage.setItem('darkMode', 'enabled'); // 存储状态
            } else {
                document.body.removeAttribute('data-bs-theme');
                localStorage.setItem('darkMode', 'disabled'); // 存储状态
            }
        });
    });
</script>